---
import BaseLayout from "./BaseLayout.astro";
import Comment from "@/components/Comment";
import type { MarkdownHeading } from "astro";
import { getCollection } from "astro:content";

// Î™©Ï∞® ÏïÑÏù¥ÌÖú ÌÉÄÏûÖ
type HeadingItem = { slug: string; text: string; depth: number };

const { frontmatter, headings = [] as MarkdownHeading[] } = Astro.props;

// üëâ headingsÎ•º Ìïú Î≤àÏóê Ïö∞Î¶¨Í∞Ä Ïì∞Í∏∞ Ï¢ãÏùÄ ÌÉÄÏûÖÏúºÎ°ú Îã®Ïñ∏
const heads = headings as unknown as HeadingItem[];

// ÎÇ†Ïßú Ìè¨Îß∑
const date =
  frontmatter.pubDate instanceof Date
    ? frontmatter.pubDate
    : new Date(frontmatter.pubDate);
const formattedDate = new Intl.DateTimeFormat("ko-KR", {
  dateStyle: "long",
}).format(date);

// Ïù¥Ï†Ñ/Îã§Ïùå Í∏Ä Í≥ÑÏÇ∞
const all = await getCollection("blog");
const posts = all.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const curPath = Astro.url.pathname.endsWith("/")
  ? Astro.url.pathname
  : Astro.url.pathname + "/";
const idx = posts.findIndex((p) => `/posts/${p.slug}/` === curPath);

const prev = idx >= 0 ? posts[idx + 1] : undefined;
const next = idx >= 0 ? posts[idx - 1] : undefined;
---

<BaseLayout pageTitle={''}>
  <div class="md-body px-2">
    <article id="md-content" class="prose prose-zinc dark:prose-invert max-w-none">
      <header class="mb-6 border-b border-[#d1d1d1] pb-4 text-black dark:text-white">
        <div class="flex items-center justify-center gap-2 bg-gray-200 dark:bg-white w-[64px] h-[64px] sm:w-[84px] sm:h-[84px] rounded-full">
          <span class="text-4xl sm:text-5xl pt-1.5">{frontmatter.imoji}</span>
        </div>

        {frontmatter.tags?.length > 0 && (
          <div class="flex flex-wrap gap-2 mt-6">
            {frontmatter.tags.map((tag: string) => (
              <a
                class="px-3 py-1 rounded text-sm text-black bg-[#fddaeb] hover:bg-[#F2ACC7] no-underline"
                href={`/tags/${tag}`}
              >
                {tag}
              </a>
            ))}
          </div>
        )}

        <div class="md-title mt-4 flex justify-start text-3xl sm:text-4xl font-bold">
          {frontmatter.title}
        </div>
        <div class="mt-3 text-md text-zinc-400">{formattedDate}</div>
      </header>

      <slot />

      {(prev || next) && (
        <nav aria-label="Ïù¥Ï†Ñ/Îã§Ïùå Í∏Ä" class="mt-10">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            {prev && (
              <a
                href={`/posts/${prev.slug}/`}
                class="block rounded-2xl bg-gray-100 dark:bg-zinc-400/30 no-underline py-8 px-6 shadow-sm transition-all duration-300 hover:-translate-y-0.5 hover:shadow-md"
              >
                <div class="text-md text-zinc-400 mb-2">Ïù¥Ï†Ñ Í∏Ä</div>
                <div class="text-xl font-semibold text-zinc-900 dark:text-zinc-100 line-clamp-2">
                  {prev.data.title}
                </div>
              </a>
            )}

            {next && (
              <a
                href={`/posts/${next.slug}/`}
                class="block rounded-2xl bg-gray-100 dark:bg-zinc-400/30 no-underline py-8 px-6 shadow-sm transition-all duration-300 hover:-translate-y-0.5 hover:shadow-md"
              >
                <div class="text-md text-zinc-400 mb-2 text-right sm:text-left">Îã§Ïùå Í∏Ä</div>
                <div class="text-xl font-semibold text-zinc-900 dark:text-zinc-100 line-clamp-2">
                  {next.data.title}
                </div>
              </a>
            )}
          </div>
        </nav>
      )}
    </article>
  </div>

  <aside
    id="toc-rail"
    class="hidden lg:block fixed z-30 top-24 w-72 max-h-[calc(100vh-8rem)] overflow-auto px-3"
    aria-label="Î™©Ï∞®"
  >
    <p class="mb-3 text-md font-medium text-zinc-500">Î™©Ï∞®</p>

    {heads.length === 0 ? (
      <></>
    ) : (
      <ul class="space-y-1.5 text-sm">
        {heads
          .filter((h) => h.depth >= 1 && h.depth <= 3)
          .map((h) => (
            <li class={`leading-6 ${h.depth === 3 ? "pl-4" : ""}`}>
              <a
                href={`#${h.slug}`}
                class="block truncate text-zinc-700 hover:underline dark:text-zinc-300 dark:hover:text-white"
              >
                {h.text}
              </a>
            </li>
          ))}
      </ul>
    )}
  </aside>

  <Comment client:load />
</BaseLayout>

<script>
  const content = document.getElementById('md-content');
  const rail = document.getElementById('toc-rail');
  if (content && rail) {
    const GUTTER = 24;
    const MIN_RIGHT = 16;

    const place = () => {
      const rect = content.getBoundingClientRect();
      let left = rect.right + GUTTER;
      const maxLeft = window.innerWidth - rail.offsetWidth - MIN_RIGHT;
      left = Math.min(left, maxLeft);
      if (left < rect.right) {
        rail.style.display = 'none';
      } else {
        rail.style.display = '';
        rail.style.left = `${left}px`;
      }
    };

    place();
    window.addEventListener('resize', place);
    const ro = new ResizeObserver(place);
    ro.observe(content);
  }
</script>
